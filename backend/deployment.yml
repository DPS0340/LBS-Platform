apiVersion: apps/v1
kind: Deployment
metadata:
  name: lbs-backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: lbs-backend
  template:
    metadata:
      labels:
        app: lbs-backend
    spec:
      volumes:
        - name: code
          hostPath:
            path: ${CURDIR}
            type: Directory
        - name: static
          hostPath:
            path: ${CURDIR}/static
        - name: jenkins-home
          hostPath:
            path: /var/jenkins_home/workspace
        - name: backend-logs
          hostPath:
            path: /var/jenkins_home/workspace/logs
        - name: database-volume
          hostPath:
            path: /var/jenkins_home/workspace/data/db
        - name: etc-prometheus
          hostPath:
            path: ${CURDIR}/prometheus/
        - name: prometheus-data
          hostPath:
            path: /var/jenkins_home/workspace/prometheus/data
        - name: lib-grafana
          hostPath:
            path: /var/jenkins_home/workspace/grafana
        - name: rootfs
          hostPath:
            path: /
        - name: var-run
          hostPath:
            path: /var/run
        - name: sys
          hostPath:
            path: /sys
        - name: docker-lib
          hostPath:
            path: /var/lib/docker
        - name: cgroup
          hostPath:
            path: /var/cgroup
        - name: proc
          hostPath:
            path: /var/proc
      containers:
        - name: gunicorn-backend
          image: a891/lbs-gunicorn-backend:latest
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: jenkins-home
              mountPath: /var/jenkins_home/workspace
          resources:
            limits:
              memory: 512Mi
              cpu: "1"
          env:
            - name: Django_secret_key
              value: "${Django_secret_key}"
            - name: DJANGO_SUPERUSER_PASSWORD
              value: "${DJANGO_SUPERUSER_PASSWORD}"
            - name: DJANGO_SUPERUSER_USERNAME
              value: "${DJANGO_SUPERUSER_USERNAME}"
            - name: DJANGO_SUPERUSER_EMAIL
              value: "${DJANGO_SUPERUSER_EMAIL}"
            - name: IS_LOCAL
              value: "${IS_LOCAL}"
          ports:
            - containerPort: 8000
        - name: nginx-backend
          image: a891/lbs-nginx-backend:latest
          ports:
            - containerPort: 80
              hostPort: 80
              protocol: TCP
            - name: http2
              containerPort: 80
              hostPort: 5001
              protocol: TCP
            - name: https
              containerPort: 443
              hostPort: 443
              protocol: TCP

          resources:
            limits:
              memory: 512Mi
              cpu: "1"
          env:
            - name: NGINX_HOST
              value: "0.0.0.0"
            - name: NGINX_PORT
              value: "80"
          volumeMounts:
            - name: backend-logs
              mountPath: /var/backend-logs
            - name: static
              mountPath: /static
        - name: database
          image: postgres
          securityContext:
            runAsUser: 0
          ports:
            - containerPort: 5432
          resources:
            limits:
              memory: 512Mi
              cpu: "1"
          env:
            - name: PGDATA
              value: "/var/lib/postgresql/data/django/"
            - name: POSTGRES_USER
              value: "${POSTGRES_USER}"
            - name: POSTGRES_PASSWORD
              value: "${POSTGRES_PASSWORD}"
            - name: POSTGRES_DB
              value: "${POSTGRES_DB}"
            - name: POSTGRES_HOST_AUTH_METHOD
              value: "trust"
          volumeMounts:
            - name: database-volume
              mountPath: /var/lib/postgresql/data/django/
        - name: prometheus
          image: prom/prometheus
          securityContext:
            runAsUser: 0
          ports:
            - containerPort: 9090
              hostPort: 9090
              protocol: TCP
          resources:
            limits:
              memory: 512Mi
              cpu: "1"
          command:
            [
              "--config.file=/etc/prometheus/prometheus.yml",
              "--storage.tsdb.path=/prometheus",
              "--web.console.libraries=/usr/share/prometheus/console_libraries",
              "--web.console.templates=/usr/share/prometheus/consoles",
            ]
          volumeMounts:
            - name: etc-prometheus
              mountPath: /etc/prometheus
            - name: prometheus-data
              mountPath: /prometheus
        - name: grafana
          image: grafana/grafana
          securityContext:
            runAsUser: 0
          ports:
            - containerPort: 3000
              hostPort: 3000
              protocol: TCP
          resources:
            limits:
              memory: 512Mi
              cpu: "1"
          volumeMounts:
            - name: lib-grafana
              mountPath: /var/lib/grafana
        - name: cadvisor
          image: google/cadvisor:latest
          securityContext:
            privileged: true
            runAsUser: 0
          ports:
            - hostPort: 8080
              containerPort: 8080
              protocol: TCP
          resources:
            limits:
              memory: 512Mi
              cpu: "1"
          volumeMounts:
            - name: rootfs
              mountPath: /rootfs
              readOnly: true
            - name: var-run
              mountPath: /var/run
            - name: sys
              mountPath: /sys
              readOnly: true
            - name: docker-lib
              mountPath: /var/lib/docker
              readOnly: true
            - name: cgroup
              mountPath: /cgroup
              readOnly: true
        - name: node-exporter
          image: prom/node-exporter
          securityContext:
            runAsUser: 0
          ports:
            - hostPort: 9100
              containerPort: 9100
              protocol: TCP
          resources:
            limits:
              memory: 512Mi
              cpu: "1"
          volumeMounts:
            - name: proc
              mountPath: /host/proc
              readOnly: true
            - name: sys
              mountPath: /host/sys
              readOnly: true
            - name: rootfs
              mountPath: /rootfs
              readOnly: true
          command:
            [
              "--path.procfs=/host/proc",
              "--path.sysfs=/host/sys",
              "--collector.filesystem.ignored-mount-points",
              "^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs)($$|/)",
            ]
